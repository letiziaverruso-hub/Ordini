<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Ordini Prodotti</title>
    <!-- Carica Tailwind CSS per uno stile moderno e responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4CAF50', // Verde Montesarchio
                        'secondary': '#FF9800', // Arancione Accento
                        'edit': '#2196F3', // Blu per l'azione di modifica
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Stili personalizzati per l'interfaccia mobile/tablet */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
        }
        .app-container {
            max-width: 768px; /* Tablet breakpoint */
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        .keyboard-key {
            @apply p-4 m-0.5 rounded-lg text-2xl font-bold transition duration-150 ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-active {
            @apply ring-4 ring-primary ring-opacity-50;
        }
    </style>
</head>
<body class="selection:bg-primary selection:text-white">

    <div id="app" class="app-container">

        <!-- 1. Header con Selezione Titolo e Pulsante Aggiungi Prodotto -->
        <header class="p-4 bg-primary text-white shadow-lg sticky top-0 z-10">
            <h1 id="header-title" class="text-xl font-extrabold text-center">Montesarchio</h1>
            <div class="flex justify-between items-center mt-2">
                <select id="title-selector" class="bg-white text-gray-800 p-1.5 rounded-md text-sm shadow-md focus:ring-2 focus:ring-secondary">
                    <option value="Montesarchio">Montesarchio</option>
                    <option value="Benevento">Benevento</option>
                </select>
                <div class="flex space-x-2">
                    <button id="show-summary-btn" class="bg-secondary hover:bg-orange-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow-md transition duration-200 text-sm">
                        Riepilogo
                    </button>
                    <button id="add-product-btn" class="bg-secondary hover:bg-orange-600 text-white font-semibold py-1.5 px-3 rounded-lg shadow-md transition duration-200 text-sm">
                        + Prodotto
                    </button>
                </div>
            </div>
        </header>

        <!-- 2. Main Content: Lista Prodotti -->
        <main id="main-list-view" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- La lista dei prodotti verrà popolata qui, divisa per categorie -->
            <div id="product-list" class="space-y-4"></div>
        </main>

        <!-- 3. Tastiera Numerica (Fixed at bottom) -->
        <div id="keyboard-container" class="sticky bottom-0 bg-gray-100 border-t border-gray-300 p-2 shadow-2xl">
            <h2 class="text-lg font-semibold text-gray-700 mb-2 px-2">Quantità Selezionata: <span id="current-quantity" class="text-primary font-extrabold">0</span></h2>
            <div id="keyboard" class="grid grid-cols-4 gap-1">
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="7">7</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="8">8</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="9">9</button>
                <button class="keyboard-key bg-primary text-white hover:bg-green-600 col-span-1 row-span-2" data-key="APPLY">APPLICA</button>

                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="4">4</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="5">5</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="6">6</button>

                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="1">1</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="2">2</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="3">3</button>
                <button class="keyboard-key bg-red-500 text-white hover:bg-red-600 col-span-1 row-span-2" data-key="CLEAR">AZZERA</button>

                <button class="keyboard-key bg-gray-300 text-gray-800 hover:bg-gray-400 col-span-1" data-key="BACK">⌫</button>
                <button class="keyboard-key bg-white text-gray-800 hover:bg-gray-200 col-span-1" data-key="0">0</button>
                <button class="keyboard-key bg-gray-300 text-gray-800 hover:bg-gray-400 col-span-1" data-key="RESET_INPUT">PULISCI</button>
            </div>
        </div>

        <!-- 4. Modale/View Riepilogo -->
        <div id="summary-view" class="fixed inset-0 bg-white z-20 p-4 transition-transform duration-300 transform translate-x-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-primary">Riepilogo Ordine - <span id="summary-title">Montesarchio</span></h2>
                <button id="close-summary-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>

            <div id="summary-content" class="text-xs">
                <!-- Il riepilogo verrà popolato qui -->
            </div>

            <button id="copy-summary-btn" class="mt-4 w-full bg-secondary hover:bg-orange-600 text-white font-bold py-2 rounded-lg shadow-md transition duration-200">
                Copia Testo
            </button>
            <div id="copy-message" class="text-center text-primary mt-2 hidden">Copiato negli appunti!</div>
        </div>

        <!-- 5. Modale Aggiungi Prodotto -->
        <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-lg font-bold mb-4">Aggiungi Nuovo Prodotto</h3>
                <input type="text" id="new-product-name" placeholder="Nome Prodotto (es: Nuovo Biscotto)" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-primary focus:border-primary">
                <input type="text" id="new-product-unit" placeholder="Unità (es: Pz, Conf, Kg)" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-primary focus:border-primary">
                <select id="new-product-category" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-primary focus:border-primary">
                    <option value="">Seleziona Categoria</option>
                    <!-- Le opzioni della categoria saranno aggiunte da JS -->
                </select>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-add-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800 rounded-md">Annulla</button>
                    <button id="save-new-product-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-green-600">Salva</button>
                </div>
            </div>
        </div>

        <!-- 6. Modale Modifica Nome Prodotto -->
        <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-lg font-bold mb-4">Modifica Nome Prodotto</h3>
                <input type="hidden" id="edit-product-id">
                <input type="text" id="edit-product-name" placeholder="Nuovo Nome Prodotto" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-edit focus:border-edit">
                <div class="flex justify-end space-x-3">
                    <button id="cancel-edit-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800 rounded-md">Annulla</button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-edit text-white rounded-md hover:bg-blue-600">Salva</button>
                </div>
            </div>
        </div>

        <!-- Messaggio di errore/successo -->
        <div id="message-box" class="fixed top-4 right-4 p-3 bg-red-500 text-white rounded-lg shadow-xl hidden transition duration-300 z-50"></div>

    </div>

<script type="module">
    // Importazioni Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Imposta il livello di log per Firestore (Utile per il debug)
    setLogLevel('Debug');

    // Variabili Globali (fornite dall'ambiente Canvas)
    let app;
    let db;
    let auth;
    let userId = null;
    let currentData = { products: [] }; // Stato locale dei prodotti

    // Stato dell'input
    let activeInputId = null; // ID del prodotto attualmente selezionato
    let currentQuantityInput = ''; // Valore numerico in costruzione
    
    // Inizializzazione sicura delle variabili globali
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let firebaseConfig = null;
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
    try {
        if (firebaseConfigString) {
            // Tenta di fare il parse solo se la stringa esiste, con gestione degli errori
            firebaseConfig = JSON.parse(firebaseConfigString);
        }
    } catch (e) {
        console.error("Errore nel parsing della configurazione Firebase:", e);
    }
    // Fine Inizializzazione sicura

    // Categorie definite (AGGIORNATE in base alla modifica dell'utente)
    const CATEGORIES = {
        'congelati': "1. Congelati",
        'scaffali': "2. Scaffali",
        'materie_prime': "4. Materie Prime (Farine & Ingredienti Base)",
        'conserve_marmellate': "7. Conserve & Marmellate",
        'bevande': "8. Bevande (Acque, Bibite, Birre)",
        'natale': "9. Natale",
        'confezionamento_buste': "10. Confezionamento & Buste",
        'cancelleria_varie': "11. Cancelleria & Varie",
        'mieli': "12. Miele",
        'detergenti_pulizia': "13. Detergenti & Pulizia",
        'strumenti_attrezzature': "14. Strumenti & Attrezzature",
        'altro': "15. Altro/Personalizzati"
    };

    // Lista iniziale dei prodotti (AGGIORNATA in base alla modifica dell'utente)
    const INITIAL_PRODUCTS = [
        // 1. Congelati
        { name: "Pizza Parigina", unit: "Teglie", category: "congelati" },
        { name: "Foc. Scarola", unit: "Pz", category: "congelati" },
        { name: "Cornetti crema", unit: "Pz", category: "congelati" },
        { name: "Fagottino", unit: "Pz", category: "congelati" },
        { name: "Cornetto Vuoto", unit: "Pz", category: "congelati" },
        { name: "Ciambelle", unit: "Pz", category: "congelati" },
        { name: "Rustici Grandi", unit: "Pz", category: "congelati" },
        { name: "Rustici Mignon", unit: "Pz", category: "congelati" },

        // 2. Scaffali
        { name: "Biscotta Bianca", unit: "Pacco", category: "scaffali" },
        { name: "Biscotta Integrale", unit: "Pacco", category: "scaffali" },
        { name: "Fresella Bianca", unit: "Pacco", category: "scaffali" },
        { name: "Fresella Integrale", unit: "Pacco", category: "scaffali" },
        { name: "Fresella Tonda Bianca", unit: "Pacco", category: "scaffali" },
        { name: "Fresella Tonda Integrale", unit: "Pacco", category: "scaffali" },
        { name: "Pastarelle Bianche", unit: "Pacco", category: "scaffali" },
        { name: "Pastarelle al Cacao", unit: "Pacco", category: "scaffali" },
        { name: "Pastarelle al Cacao Morbide", unit: "Pacco", category: "scaffali" },
        { name: "Pastarelle Mandorlate", unit: "Pacco", category: "scaffali" },
        { name: "Novellini", unit: "Pacco", category: "scaffali" },
        { name: "Torcetti al burro", unit: "Pacco", category: "scaffali" },
        { name: "Ciambelline al vino rosso", unit: "Pacco", category: "scaffali" },
        { name: "Taralli al finocchietto", unit: "Pacco", category: "scaffali" },
        { name: "Taralli Extravergine", unit: "Pacco", category: "scaffali" },
        { name: "Taralli Integrali", unit: "Pacco", category: "scaffali" },
        { name: "Crostini Proteici", unit: "Pacco", category: "scaffali" },
        { name: "Carbonelle", unit: "CRT", category: "scaffali" },
        { name: "Farina tipo \"00\"", unit: "Kg", category: "scaffali" },
        { name: "Farina grano duro", unit: "Kg", category: "scaffali" },
        { name: "Farina Integrale", unit: "Kg", category: "scaffali" },
        { name: "Farina di Mais", unit: "Kg", category: "scaffali" },
        { name: "Pan Grattato", unit: "Pacco", category: "scaffali" },
        { name: "Mollica", unit: "Conf", category: "scaffali" },
        { name: "Uova", unit: "Conf", category: "scaffali" },
        { name: "Treccine", unit: "kg", category: "scaffali" },
        { name: "Taralli Mergellina", unit: "kg", category: "scaffali" },

        // 4. Materie Prime (Farine & Ingredienti Base)
        { name: "zucchero semolato", unit: "Kg", category: "materie_prime" },
        { name: "Lievito pan degli angeli", unit: "Conf", category: "materie_prime" },
        { name: "Gocce di cioccolato", unit: "Kg", category: "materie_prime" },
        { name: "Mozzarella", unit: "Pz", category: "materie_prime" },
        { name: "Prosciutto Cotto", unit: "Conf", category: "materie_prime" },
        { name: "Olio di semi girasole", unit: "Litro", category: "materie_prime" },
        { name: "Olio extravergine di oliva", unit: "Conf", category: "materie_prime" },
        { name: "Barattoli Scarola", unit: "Pz", category: "materie_prime" },

        // 7. Conserve & Marmellate
        { name: "Marmellata frutti di bosco", unit: "Conf", category: "conserve_marmellate" },
        { name: "Marmellata albicocche", unit: "Conf", category: "conserve_marmellate" },
        { name: "Marmellata ciliegie", unit: "Conf", category: "conserve_marmellate" },
        { name: "Sugo", unit: "Conf", category: "conserve_marmellate" },
        { name: "Nutella", unit: "Barattolo", category: "conserve_marmellate" },

        // 8. Bevande (Acque, Bibite, Birre)
        { name: "Acqua L 1.5 liscia", unit: "Conf", category: "bevande" },
        { name: "Acqua L 0.5 liscia", unit: "Conf", category: "bevande" },
        { name: "Acqua L 1.5 frizzante", unit: "Conf", category: "bevande" },
        { name: "Acqua L 0.5 frizzante", unit: "Conf", category: "bevande" },
        { name: "Coca-Cola Lattina", unit: "Conf", category: "bevande" },
        { name: "Coca-Cola L 1.5", unit: "Conf", category: "bevande" },
        { name: "Esta the limone", unit: "Conf", category: "bevande" },
        { name: "Esta the pesca", unit: "Conf", category: "bevande" },
        { name: "Ceres", unit: "Conf", category: "bevande" },
        { name: "Fanta", unit: "Conf", category: "bevande" },

        // 9. Natale
        { name: "Mostacciuoli Rhum", unit: "Conf", category: "natale" },
        { name: "Mostacciuoli Classici", unit: "Conf", category: "natale" },

        // 10. Confezionamento & Buste
        { name: "Carta Forno", unit: "Rotolo", category: "confezionamento_buste" },
        { name: "Shopperini", unit: "Kg", category: "confezionamento_buste" },
        { name: "Sacchetti carta Filone", unit: "Kg", category: "confezionamento_buste" },
        { name: "Sacchetti carta Panello", unit: "Kg", category: "confezionamento_buste" },
        { name: "Sacchetti carta 1/2 kg", unit: "Kg", category: "confezionamento_buste" },
        { name: "Sacchetti carta Scanata", unit: "Kg", category: "confezionamento_buste" },
        { name: "Sacchetti Cornetti", unit: "Kg", category: "confezionamento_buste" },
        { name: "Carta finissima", unit: "Kg", category: "confezionamento_buste" },
        { name: "Vassoi fondo oro", unit: "Pz", category: "confezionamento_buste" },
        { name: "Sovrainvolto Avana", unit: "Pz", category: "confezionamento_buste" },
        { name: "Cartoni pizza Grandi", unit: "Pz", category: "confezionamento_buste" },
        { name: "Cartoni pizza Piccoli", unit: "Pz", category: "confezionamento_buste" },
        { name: "Buste Spazzatura Grandi", unit: "Conf", category: "confezionamento_buste" },
        { name: "Buste per Impasto", unit: "Conf", category: "confezionamento_buste" },
        { name: "Buste Spazzature Piccole", unit: "Conf", category: "confezionamento_buste" },
        { name: "Buste pan Grattato", unit: "Conf", category: "confezionamento_buste" },
        { name: "Carta Intestata", unit: "Pz", category: "confezionamento_buste" },

        // 11. Cancelleria & Varie
        { name: "Rotoli reg. cassa", unit: "Rotolo", category: "cancelleria_varie" },
        { name: "Scotch piccolo", unit: "Pz", category: "cancelleria_varie" },
        { name: "Scotch grande", unit: "Pz", category: "cancelleria_varie" },
        { name: "Pennarelli", unit: "Pz", category: "cancelleria_varie" },
        { name: "Biglietti da visita", unit: "Pz", category: "cancelleria_varie" },

        // 12. Miele
        { name: "Miele cf 50 gr.", unit: "Barattolo", category: "mieli" },
        { name: "Miele Acacia", unit: "Barattolo", category: "mieli" },
        { name: "Miele Castagno", unit: "Barattolo", category: "mieli" },
        { name: "Miele Millefiori", unit: "Barattolo", category: "mieli" },
        { name: "Miele Eucalipto", unit: "Barattolo", category: "mieli" },
        { name: "Miele di Sulla", unit: "Barattolo", category: "mieli" },
        { name: "Miele Melata di Bosco", unit: "Barattolo", category: "mieli" },

        // 13. Detergenti & Pulizia
        { name: "Ters", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Alcool", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Sapone per mani", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Viakal", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Prodotti Vetri", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Smac Bagno", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Ajax (Pavimenti)", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Svelto", unit: "Conf", category: "detergenti_pulizia" },
        { name: "W.C. Bagno", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Candeggina", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Sgrassatore", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Smac Acciaio", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Carta Igienica", unit: "Conf", category: "detergenti_pulizia" },
        { name: "Stracci Scaffali", unit: "Pz", category: "detergenti_pulizia" },
        { name: "Scope Minerva", unit: "Pz", category: "detergenti_pulizia" },
        { name: "Bastone per scopa", unit: "Pz", category: "detergenti_pulizia" },
        { name: "Spugna Piatti", unit: "Pz", category: "detergenti_pulizia" },
        { name: "Stracci Pavimenti", unit: "Pz", category: "detergenti_pulizia" },
        { name: "Spray Insetticida", unit: "Bombola", category: "detergenti_pulizia" },

        // 14. Strumenti & Attrezzature
        { name: "Stampi plum-cake", unit: "Pz", category: "strumenti_attrezzature" },
        { name: "Stampi Rotondi", unit: "Pz", category: "strumenti_attrezzature" },
        { name: "Guanti Pane", unit: "Conf", category: "strumenti_attrezzature" },
        { name: "Tovagliolini", unit: "Conf", category: "strumenti_attrezzature" },
        { name: "Guanti Monouso", unit: "Conf", category: "strumenti_attrezzature" } // Unità ripristinata a Conf
    ];


    /**
     * Funzione per mostrare messaggi (simula un alert in modo non bloccante)
     * @param {string} message Il messaggio da mostrare
     * @param {string} type 'success' o 'error'
     */
    function showMessage(message, type = 'success') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = `fixed top-4 right-4 p-3 text-white rounded-lg shadow-xl transition duration-300 ${type === 'success' ? 'bg-primary' : 'bg-red-500'} z-50`;
        msgBox.style.display = 'block';

        // Nasconde il messaggio dopo 3 secondi
        setTimeout(() => {
            msgBox.style.display = 'none';
        }, 3000);
    }

    /**
     * Inizializzazione Firebase
     */
    async function initializeFirebase() {
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticazione: usa token personalizzato se disponibile, altrimenti anonima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Ottieni l'ID utente dopo l'autenticazione
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Avvia il listener di Firestore una volta che l'utente è autenticato
                        startFirestoreListener();
                    } else {
                        userId = null;
                        showMessage("Errore: Autenticazione Firebase fallita.", 'error');
                    }
                });
            } catch (e) {
                console.error("Errore di inizializzazione Firebase:", e);
                showMessage("Errore critico: Impossibile connettersi al database.", 'error');
            }
        } else {
            // Se non c'è config, usa dati di fallback (solo per sviluppo locale)
            console.warn("Configurazione Firebase non trovata. Usando dati locali.");
            // Inizializza i prodotti una volta se non c'è Firebase
            currentData.products = INITIAL_PRODUCTS.map((p, index) => ({
                id: `prod-${index}`,
                name: p.name,
                unit: p.unit,
                category: p.category,
                quantity: 0
            }));
            renderProductList();
        }
    }

    /**
     * Avvia il listener di Firestore per i dati dell'utente.
     */
    function startFirestoreListener() {
        if (!userId || !db) return;

        // Path del documento: /artifacts/{appId}/users/{userId}/orderData/current
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'orderData', 'current');

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                // Il documento esiste, carica i dati
                const data = docSnap.data();
                const parsedData = typeof data.orderData === 'string' ? JSON.parse(data.orderData) : null;
                
                // Aggiornamento Intelligente dei Prodotti
                if (parsedData && parsedData.products) {
                    const existingProductsMap = new Map(parsedData.products.map(p => [p.name, p]));
                    const updatedProducts = [];

                    // 1. Mantieni i prodotti INIZIALI esistenti, aggiornandone l'ID e la categoria se necessario
                    INITIAL_PRODUCTS.forEach((p, index) => {
                        const existing = existingProductsMap.get(p.name);
                        if (existing) {
                            // Se esiste, usa la quantità salvata
                            updatedProducts.push({
                                ...existing,
                                unit: p.unit, // Forza l'unità e la categoria dalla lista di base
                                category: p.category,
                            });
                            existingProductsMap.delete(p.name); // Rimuovi dall'elenco di quelli da aggiungere
                        } else {
                            // Se nuovo o rientrato, aggiungi con quantità 0
                            updatedProducts.push({
                                id: `prod-${index}-${Date.now()}`,
                                name: p.name,
                                unit: p.unit,
                                category: p.category,
                                quantity: 0
                            });
                        }
                    });

                    // 2. Aggiungi i prodotti PERSONALIZZATI che non sono stati eliminati
                    existingProductsMap.forEach(product => {
                        // Aggiungi solo i prodotti personalizzati (non della lista iniziale)
                        if (product.id.startsWith('custom-')) {
                            updatedProducts.push(product);
                        }
                    });
                    
                    currentData.products = updatedProducts;
                } else {
                    // Se i dati salvati sono vuoti o rotti, reinizializza
                     currentData.products = INITIAL_PRODUCTS.map((p, index) => ({
                        id: `prod-${index}`,
                        name: p.name,
                        unit: p.unit,
                        category: p.category,
                        quantity: 0
                    }));
                }
                
                // Forza il salvataggio per sincronizzare l'ID e la categoria se la lista è cambiata
                saveOrderData();
                
            } else {
                // Il documento non esiste, inizializza con i prodotti di base
                console.log("Nessun dato trovato, reinizializzo il database.");
                initializeOrderData();
            }
            renderProductList();
        }, (error) => {
            console.error("Errore di onSnapshot:", error);
            showMessage("Errore nel caricamento dei dati in tempo reale.", 'error');
        });
    }

    /**
     * Inizializza i dati dell'ordine nel database
     */
    async function initializeOrderData() {
        if (!userId || !db) return;

        // Assegna ID unici ai prodotti iniziali
        currentData.products = INITIAL_PRODUCTS.map((p, index) => ({
            id: `prod-${index}`,
            name: p.name,
            unit: p.unit,
            category: p.category,
            quantity: 0
        }));

        await saveOrderData();
    }

    /**
     * Salva i dati dell'ordine nel database
     */
    async function saveOrderData() {
        if (!userId || !db) return;

        try {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'orderData', 'current');
            await setDoc(docRef, {
                orderData: JSON.stringify(currentData),
                timestamp: new Date().getTime()
            }, { merge: false });
        } catch (e) {
            console.error("Errore nel salvataggio dei dati:", e);
            showMessage("Errore nel salvataggio automatico dei dati.", 'error');
        }
    }

    /**
     * Aggiunge un nuovo prodotto alla lista e lo salva.
     * @param {string} name Nome del prodotto
     * @param {string} unit Unità di misura
     * @param {string} category Categoria
     */
    async function addNewProduct(name, unit, category) {
        const newProduct = {
            id: `custom-${Date.now()}`,
            name: name,
            unit: unit,
            category: category,
            quantity: 0
        };
        currentData.products.push(newProduct);
        await saveOrderData();
        showMessage(`Prodotto '${name}' aggiunto.`);
        renderProductList();
    }

    /**
     * Modifica il nome di un prodotto esistente.
     * @param {string} productId ID del prodotto
     * @param {string} newName Nuovo nome del prodotto
     */
    async function editProductName(productId, newName) {
        const productIndex = currentData.products.findIndex(p => p.id === productId);
        if (productIndex !== -1) {
            const oldName = currentData.products[productIndex].name;
            currentData.products[productIndex].name = newName;
            
            // Per i prodotti predefiniti (che non iniziano con 'custom-'), il nome non è la chiave di categorizzazione qui
            // La categoria rimane quella della lista INITIAL_PRODUCTS, ma se è un prodotto personalizzato, la categoria rimane quella che l'utente ha scelto.
            
            await saveOrderData();
            showMessage(`Nome prodotto modificato da '${oldName}' a '${newName}'.`);
            renderProductList();
        }
    }

    // --- Logica dell'Interfaccia Utente ---

    /**
     * Renderizza la lista dei prodotti nell'interfaccia, raggruppati per categoria.
     */
    function renderProductList() {
        const listContainer = document.getElementById('product-list');
        listContainer.innerHTML = ''; 

        if (currentData.products.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center mt-8">Nessun prodotto disponibile. Aggiungine uno per iniziare.</p>';
            return;
        }

        // 1. Raggruppa i prodotti per categoria
        const productsByCategory = currentData.products.reduce((acc, product) => {
            const categoryId = product.category || 'altro';
            if (!acc[categoryId]) {
                acc[categoryId] = [];
            }
            acc[categoryId].push(product);
            return acc;
        }, {});

        // 2. Ordina le categorie utilizzando l'ordine definito nella mappa CATEGORIES
        const sortedCategoryIds = Object.keys(CATEGORIES).filter(id => productsByCategory[id]);

        // 3. Renderizza
        sortedCategoryIds.forEach(categoryId => {
            const categoryName = CATEGORIES[categoryId] || CATEGORIES['altro'];
            const products = productsByCategory[categoryId].sort((a, b) => a.name.localeCompare(b.name));

            // Container Categoria
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-group';
            
            // Titolo Categoria. Si attacca un po' più sotto per permettere lo scrolling completo
            categoryDiv.innerHTML = `
                <h2 class="text-lg font-bold text-gray-700 bg-gray-200 p-2 rounded-t-lg sticky top-20 z-10 shadow-sm">${categoryName}</h2>
                <div class="space-y-1 pt-1"></div>
            `;
            const listGroup = categoryDiv.querySelector('div');

            products.forEach(product => {
                const isActive = activeInputId === product.id;
                const isCustom = product.id.startsWith('custom-');
                
                const item = document.createElement('div');
                item.className = `p-3 flex justify-between items-center rounded-lg shadow-sm border ${isActive ? 'bg-green-50 border-primary' : 'bg-white border-gray-200'} transition duration-150`;
                item.dataset.productId = product.id;

                item.innerHTML = `
                    <div class="flex-1 min-w-0 mr-2">
                        <div class="flex items-center space-x-2">
                            <p class="text-sm font-medium text-gray-800 truncate">${product.name}</p>
                            <button class="edit-btn text-edit hover:text-blue-600 text-base leading-none" data-product-id="${product.id}" data-product-name="${product.name}" title="Modifica Nome">
                                &#9999;&#xFE0F; 
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">${product.unit}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input
                            type="text"
                            readonly
                            value="${product.quantity}"
                            data-product-id="${product.id}"
                            class="quantity-input w-16 text-center text-lg font-bold p-1 rounded-md border-2 focus:outline-none ${isActive ? 'border-primary input-active' : 'border-gray-300'}"
                        >
                        <button class="remove-btn text-red-400 hover:text-red-600 text-2xl font-light leading-none" data-product-id="${product.id}" title="${isCustom ? 'Rimuovi' : 'Azzera'}">
                            &times;
                        </button>
                    </div>
                `;
                listGroup.appendChild(item);
            });
            listContainer.appendChild(categoryDiv);
        });

        // Applica i listener ai nuovi elementi di input
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('click', handleInputFocus);
        });
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEditProductModal);
        });
        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', handleRemoveProduct);
        });
    }

    /**
     * Gestisce il focus sull'input del prodotto.
     * @param {Event} e L'evento click
     */
    function handleInputFocus(e) {
        // Rimuovi la classe 'input-active' da tutti gli input
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.classList.remove('input-active');
            input.closest('[data-product-id]').classList.remove('bg-green-50', 'border-primary');
        });

        const input = e.target;
        activeInputId = input.dataset.productId;
        currentQuantityInput = String(input.value) === '0' ? '' : String(input.value);

        // Aggiungi la classe 'input-active' all'input selezionato e al suo contenitore
        input.classList.add('input-active');
        input.closest('[data-product-id]').classList.add('bg-green-50', 'border-primary');

        updateCurrentQuantityDisplay();
    }

    /**
     * Aggiorna il display della quantità nella tastiera.
     */
    function updateCurrentQuantityDisplay() {
        const display = document.getElementById('current-quantity');
        display.textContent = currentQuantityInput || '0';
    }

    /**
     * Gestisce i click sui tasti della tastiera.
     * @param {Event} e L'evento click
     */
    function handleKeyClick(e) {
        const key = e.target.dataset.key;
        if (!key) return;

        if (key >= '0' && key <= '9') {
            if (currentQuantityInput.length < 5) { // Limita a 5 cifre
                currentQuantityInput += key;
            }
        } else if (key === 'BACK') {
            currentQuantityInput = currentQuantityInput.slice(0, -1);
        } else if (key === 'RESET_INPUT') {
            currentQuantityInput = '';
        } else if (key === 'CLEAR') {
            if (activeInputId) {
                applyQuantity(0);
                currentQuantityInput = '';
            }
        } else if (key === 'APPLY') {
            const quantity = currentQuantityInput === '' ? 0 : parseInt(currentQuantityInput);
            applyQuantity(quantity);
            // Non azzerare l'input dopo l'applicazione per l'inserimento rapido
        }

        updateCurrentQuantityDisplay();
    }

    /**
     * Applica la quantità all'input attivo e salva nel database.
     * @param {number} quantity La quantità da applicare
     */
    async function applyQuantity(quantity) {
        if (!activeInputId) {
            showMessage("Seleziona un prodotto prima di applicare la quantità.", 'error');
            return;
        }

        const productIndex = currentData.products.findIndex(p => p.id === activeInputId);
        if (productIndex !== -1) {
            currentData.products[productIndex].quantity = quantity;

            // Aggiorna l'input nella UI in tempo reale
            const activeInput = document.querySelector(`.quantity-input[data-product-id="${activeInputId}"]`);
            if (activeInput) {
                activeInput.value = quantity;
            }

            // Imposta l'input della tastiera al valore appena applicato per continuare a modificare
            currentQuantityInput = String(quantity);

            await saveOrderData();
        }
    }

    /**
     * Genera la stringa di riepilogo per la copia.
     * @returns {string} Il riepilogo formattato
     */
    function generateSummaryText() {
        const title = document.getElementById('header-title').textContent;

        let summary = `*** ORDINE ${title.toUpperCase()} (${new Date().toLocaleDateString()}) ***\n\n`;
        
        // 1. Filtra e ordina solo i prodotti con quantità > 0 (raggruppati per categoria)
        const orderedItems = currentData.products
            .filter(p => p.quantity > 0)
            .sort((a, b) => a.name.localeCompare(b.name));

        const orderedByCategory = orderedItems.reduce((acc, p) => {
            const categoryName = CATEGORIES[p.category] || CATEGORIES['altro'];
            if (!acc[categoryName]) { acc[categoryName] = []; }
            acc[categoryName].push(p);
            return acc;
        }, {});

        // Ordina le categorie per nome in base alla mappa CATEGORIES
        const sortedCategoryNames = Object.values(CATEGORIES).filter(name => Object.keys(orderedByCategory).includes(Object.keys(CATEGORIES).find(key => CATEGORIES[key] === name)));

        if (orderedItems.length > 0) {
            summary += "--- PRODOTTI DA ORDINARE (SOLO > 0) ---\n";
            
            sortedCategoryNames.forEach(categoryName => {
                if (orderedByCategory[categoryName]) {
                    summary += `\n== ${categoryName} ==\n`;
                    const products = orderedByCategory[categoryName];
                    const maxNameLength = products.reduce((max, p) => Math.max(max, `${p.name} (${p.unit})`.length), 0);

                    products.forEach(p => {
                        const nameWithUnit = `${p.name} (${p.unit})`;
                        const padding = ' '.repeat(Math.max(0, maxNameLength - nameWithUnit.length + 2)); 
                        // Formato: Nome (Unità) | Quantità
                        summary += `${nameWithUnit}${padding} | ${p.quantity}\n`;
                    });
                }
            });
            summary += "\n";
        } else {
             summary += "--- NESSUN PRODOTTO SELEZIONATO ---\n\n";
        }

        // 2. Lista completa (tutti i prodotti, per confronto)
        summary += "--- LISTA COMPLETA (TUTTI I PRODOTTI, con quantità) ---\n";
        const allItems = currentData.products.sort((a, b) => a.name.localeCompare(b.name));
        const maxNameLengthAll = allItems.reduce((max, p) => Math.max(max, p.name.length), 0);

        allItems.forEach(p => {
            const padding = ' '.repeat(Math.max(0, maxNameLengthAll - p.name.length + 2));
            summary += `${p.name}${padding} | ${p.quantity}\n`;
        });

        return summary;
    }

    /**
     * Renderizza il riepilogo nella vista dedicata, raggruppato per categoria.
     */
    function renderSummaryView() {
        const summaryContentDiv = document.getElementById('summary-content');
        const summaryTitleSpan = document.getElementById('summary-title');
        const summaryTitle = document.getElementById('header-title').textContent;

        summaryTitleSpan.textContent = summaryTitle;
        
        // 1. Raggruppa tutti i prodotti per categoria (ordinati per nome all'interno)
        const productsByCategory = currentData.products.reduce((acc, product) => {
            const categoryId = product.category || 'altro';
            if (!acc[categoryId]) {
                acc[categoryId] = [];
            }
            acc[categoryId].push(product);
            return acc;
        }, {});

        // 2. Ordina le categorie per nome in base alla mappa CATEGORIES
        const sortedCategoryNames = Object.values(CATEGORIES).filter(name => Object.keys(productsByCategory).includes(Object.keys(CATEGORIES).find(key => CATEGORIES[key] === name)));
        
        let htmlContent = '';
        
        // Sezione Prodotti da Ordinare (solo quelli > 0)
        const orderedItems = currentData.products.filter(p => p.quantity > 0).sort((a, b) => a.name.localeCompare(b.name));
        
        if (orderedItems.length > 0) {
             htmlContent += `<p class="font-bold border-b pb-1 mb-3 text-base text-primary">PRODOTTI DA ORDINARE (Quantità > 0)</p>`;
             orderedItems.forEach(p => {
                 htmlContent += `<div class="flex justify-between border-b border-gray-100 pb-0.5 text-sm">
                    <span class="text-gray-600 truncate">${p.name} <span class="text-xs text-gray-400">(${p.unit})</span></span>
                    <span class="font-bold text-gray-800">${p.quantity} x</span>
                </div>`;
             });
             htmlContent += `<div class="pt-4 border-t mt-4"></div>`;
        } else {
             htmlContent += `<p class="text-gray-500 text-center mb-4 text-sm">Nessun prodotto selezionato per l'ordine.</p>`;
        }
        
        // Sezione Lista Completa (divisa per Categoria)
        htmlContent += `<p class="font-bold border-t pt-4 mt-2 text-base text-gray-700">LISTA COMPLETA (Divisa per Categoria)</p>`;
        
        sortedCategoryNames.forEach(categoryName => {
            const categoryId = Object.keys(CATEGORIES).find(key => CATEGORIES[key] === categoryName);
            if (productsByCategory[categoryId]) {
                const products = productsByCategory[categoryId].sort((a, b) => a.name.localeCompare(b.name));
                
                htmlContent += `<h3 class="text-sm font-semibold text-gray-600 mt-4 mb-1 border-b border-gray-300 pb-0.5">${categoryName}</h3>`;

                products.forEach(p => {
                    htmlContent += `<div class="flex justify-between pb-0.5 text-xs">
                        <span class="text-gray-500">${p.name}</span>
                        <span class="font-bold ${p.quantity > 0 ? 'text-red-500' : 'text-gray-400'}">${p.quantity}</span>
                    </div>`;
                });
            }
        });


        // Applica i contenuti e il font minimo
        summaryContentDiv.innerHTML = htmlContent;
    }

    /**
     * Popola il selettore delle categorie nella modale di aggiunta prodotto.
     */
    function populateCategorySelector() {
        const selector = document.getElementById('new-product-category');
        // Rimuove l'opzione "Seleziona Categoria" se necessario
        selector.innerHTML = '<option value="" disabled selected>Seleziona Categoria</option>';
        
        Object.entries(CATEGORIES).forEach(([id, name]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            selector.appendChild(option);
        });
    }


    /**
     * Gestisce l'apertura della modale di modifica.
     * @param {Event} e L'evento click
     */
    function handleEditProductModal(e) {
        const productId = e.currentTarget.dataset.productId;
        const productName = e.currentTarget.dataset.productName;

        document.getElementById('edit-product-id').value = productId;
        document.getElementById('edit-product-name').value = productName;
        document.getElementById('edit-product-modal').classList.remove('hidden');
    }


    /**
     * Gestisce la rimozione di un prodotto personalizzato o l'azzeramento di un prodotto di default.
     * @param {Event} e L'evento click
     */
    async function handleRemoveProduct(e) {
        const productId = e.currentTarget.dataset.productId;
        const product = currentData.products.find(p => p.id === productId);

        if (!product) return;

        // I prodotti iniziali (ID che non inizia con 'custom-') non possono essere rimossi, solo azzerati.
        if (!productId.startsWith('custom-')) {
            product.quantity = 0;
            await saveOrderData();
            showMessage(`Quantità di '${product.name}' azzerata.`);
            return;
        }

        // Rimuovi i prodotti personalizzati (ID che inizia con 'custom-')
        const productName = product.name;
        currentData.products = currentData.products.filter(p => p.id !== productId);
        await saveOrderData();
        showMessage(`Prodotto '${productName}' rimosso.`);
    }

    // --- Inizializzazione e Listeners Principali ---

    window.onload = function() {
        initializeFirebase();
        populateCategorySelector();

        // 1. Listener Tastiera Numerica
        document.getElementById('keyboard').addEventListener('click', handleKeyClick);

        // 2. Listener Selezione Titolo
        document.getElementById('title-selector').addEventListener('change', (e) => {
            document.getElementById('header-title').textContent = e.target.value;
            document.getElementById('summary-title').textContent = e.target.value;
        });

        // 3. Gestione Modal/View Riepilogo
        const summaryView = document.getElementById('summary-view');
        document.getElementById('show-summary-btn').addEventListener('click', () => {
            renderSummaryView();
            summaryView.classList.remove('translate-x-full');
        });
        document.getElementById('close-summary-btn').addEventListener('click', () => {
            summaryView.classList.add('translate-x-full');
        });

        // 4. Funzione Copia Riepilogo
        document.getElementById('copy-summary-btn').addEventListener('click', () => {
            const summaryText = generateSummaryText();
            const copyMessage = document.getElementById('copy-message');

            // Usa document.execCommand('copy') come fallback per ambienti iframe
            const textarea = document.createElement('textarea');
            textarea.value = summaryText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyMessage.textContent = "Copiato negli appunti!";
                    copyMessage.classList.remove('hidden');
                    setTimeout(() => copyMessage.classList.add('hidden'), 2000);
                } else {
                    showMessage("Errore copia: Funzione non supportata.", 'error');
                }
            } catch (err) {
                showMessage("Errore copia: Funzione non supportata.", 'error');
            }
            document.body.removeChild(textarea);
        });

        // 5. Gestione Modal Aggiungi Prodotto
        const addModal = document.getElementById('add-product-modal');
        document.getElementById('add-product-btn').addEventListener('click', () => {
            addModal.classList.remove('hidden');
        });
        document.getElementById('cancel-add-btn').addEventListener('click', () => {
            addModal.classList.add('hidden');
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-unit').value = '';
            document.getElementById('new-product-category').value = '';
        });
        document.getElementById('save-new-product-btn').addEventListener('click', () => {
            const name = document.getElementById('new-product-name').value.trim();
            const unit = document.getElementById('new-product-unit').value.trim();
            const category = document.getElementById('new-product-category').value;

            if (name && unit && category) {
                addNewProduct(name, unit, category);
                addModal.classList.add('hidden');
                document.getElementById('new-product-name').value = '';
                document.getElementById('new-product-unit').value = '';
                document.getElementById('new-product-category').value = '';
            } else {
                showMessage("Nome, Unità e Categoria sono obbligatori.", 'error');
            }
        });
        
        // 6. Gestione Modal Modifica Prodotto
        const editModal = document.getElementById('edit-product-modal');
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            editModal.classList.add('hidden');
        });
        document.getElementById('save-edit-btn').addEventListener('click', () => {
            const productId = document.getElementById('edit-product-id').value;
            const newName = document.getElementById('edit-product-name').value.trim();
            
            if (newName) {
                editProductName(productId, newName);
                editModal.classList.add('hidden');
            } else {
                showMessage("Il nome del prodotto non può essere vuoto.", 'error');
            }
        });
    }

</script>

</body>
</html>